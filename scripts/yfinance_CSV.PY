import os
import pandas as pd
import time
import requests
import json
from datetime import datetime, timedelta

# ×”×’×“×¨×•×ª SSL ×•×¨×©×ª
os.environ["CURL_CA_BUNDLE"] = r"C:\CharlesCertFix\cacert.pem"
os.environ["REQUESTS_CA_BUNDLE"] = r"C:\CharlesCertFix\cacert.pem"

# ×”×’×“×¨×ª User-Agent
headers = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
}

def download_stock_data_yahoo(symbol, start_date, end_date, max_retries=3):
    """×”×•×¨×“×ª × ×ª×•× ×™× ×™×©×™×¨×•×ª ×-Yahoo Finance API"""
    for attempt in range(max_retries):
        try:
            print(f"ğŸ“¥ ××•×¨×™×“ × ×ª×•× ×™× ×¢×‘×•×¨ {symbol}... (× ×™×¡×™×•×Ÿ {attempt + 1}/{max_retries})")
            
            # ×”×©×”×™×™×” ×‘×™×Ÿ ×‘×§×©×•×ª
            if attempt > 0:
                wait_time = 2 ** attempt
                print(f"â³ ×××ª×™×Ÿ {wait_time} ×©× ×™×•×ª...")
                time.sleep(wait_time)
            
            # ×”××¨×ª ×ª××¨×™×›×™× ×œ-timestamp
            start_ts = int(datetime.strptime(start_date, "%Y-%m-%d").timestamp())
            end_ts = int(datetime.strptime(end_date, "%Y-%m-%d").timestamp())
            
            # URL ×©×œ Yahoo Finance
            url = f"https://query1.finance.yahoo.com/v8/finance/chart/{symbol}?period1={start_ts}&period2={end_ts}&interval=1d"
            
            response = requests.get(url, headers=headers, verify=False)
            
            if response.status_code == 200:
                data = response.json()
                
                if 'chart' in data and 'result' in data['chart'] and data['chart']['result']:
                    result = data['chart']['result'][0]
                    
                    # ×—×™×œ×•×¥ × ×ª×•× ×™×
                    timestamps = result['timestamp']
                    quotes = result['indicators']['quote'][0]
                    
                    # ×™×¦×™×¨×ª DataFrame
                    df_data = {
                        'Date': [datetime.fromtimestamp(ts) for ts in timestamps],
                        'Open': quotes.get('open', []),
                        'High': quotes.get('high', []),
                        'Low': quotes.get('low', []),
                        'Close': quotes.get('close', []),
                        'Volume': quotes.get('volume', [])
                    }
                    
                    df = pd.DataFrame(df_data)
                    df.set_index('Date', inplace=True)
                    
                    # ×”×¡×¨×ª ×©×•×¨×•×ª ×¢× ×¢×¨×›×™× ×—×¡×¨×™×
                    df = df.dropna()
                    
                    if not df.empty:
                        print(f"âœ… ×”×•×¨×“×• {len(df)} ×©×•×¨×•×ª × ×ª×•× ×™×")
                        print(f"ğŸ“… ×˜×•×•×— ×ª××¨×™×›×™×: {df.index[0].date()} ×¢×“ {df.index[-1].date()}")
                        return df
                    else:
                        print("âŒ ×œ× × ××¦××• × ×ª×•× ×™× ×ª×§×™× ×™×")
                else:
                    print("âŒ ×œ× × ××¦××• × ×ª×•× ×™× ×‘×ª×’×•×‘×”")
            else:
                print(f"âŒ ×©×’×™××ª HTTP: {response.status_code}")
                
        except Exception as e:
            print(f"âŒ ×©×’×™××” ×‘×”×•×¨×“×ª × ×ª×•× ×™× ×¢×‘×•×¨ {symbol} (× ×™×¡×™×•×Ÿ {attempt + 1}): {str(e)}")
            if attempt < max_retries - 1:
                print("ğŸ”„ ×× ×¡×” ×©×•×‘...")
            else:
                print("âŒ × ×›×©×œ×• ×›×œ ×”× ×™×¡×™×•× ×•×ª")
    
    return None

def convert_to_our_format(df, symbol):
    """×”××¨×ª ×”× ×ª×•× ×™× ×œ×¤×•×¨××˜ ×©×œ ×”××¢×¨×›×ª ×©×œ× ×•"""
    # ×™×¦×™×¨×ª DataFrame ×—×“×© ×‘×¤×•×¨××˜ ×©×œ× ×•
    new_df = pd.DataFrame({
        'Date': df.index.strftime('%m/%d/%Y'),
        'Price': df['Close'],  # Price = Close
        'Open': df['Open'],
        'High': df['High'],
        'Low': df['Low'],
        'Vol.': df['Volume'].apply(lambda x: f"{x:,.0f}"),
        'Change %': ((df['Close'] - df['Close'].shift(1)) / df['Close'].shift(1) * 100).round(2).apply(lambda x: f"{x:.2f}%")
    })
    
    # ×”×¡×¨×ª ×”×©×•×¨×” ×”×¨××©×•× ×” (××™×Ÿ ×œ×” Change %)
    new_df = new_df.iloc[1:]
    
    return new_df

def save_to_csv(df, filename):
    """×©××™×¨×ª × ×ª×•× ×™× ×œ×§×•×‘×¥ CSV ×‘×ª×™×§×™×™×ª raw_price_data"""
    try:
        # ×™×¦×™×¨×ª ×ª×™×§×™×™×ª raw_price_data ×× ×œ× ×§×™×™××ª
        raw_data_dir = "data/raw_price_data"
        os.makedirs(raw_data_dir, exist_ok=True)
        
        # × ×ª×™×‘ ××œ× ×œ×§×•×‘×¥
        file_path = os.path.join(raw_data_dir, filename)
        
        df.to_csv(file_path, index=False)
        print(f"âœ… ×©××™×¨×ª ×”×§×•×‘×¥ {file_path} ×”×•×©×œ××”")
        print(f"ğŸ“Š ×’×•×“×œ ×”×§×•×‘×¥: {len(df)} ×©×•×¨×•×ª")
        return True
    except Exception as e:
        print(f"âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”×§×•×‘×¥: {str(e)}")
        return False

def download_multiple_stocks(symbols, start_date, end_date):
    """×”×•×¨×“×ª × ×ª×•× ×™× ×œ××¡×¤×¨ ×× ×™×•×ª"""
    results = {}
    
    for symbol in symbols:
        print(f"\n{'='*50}")
        print(f"ğŸ“ˆ ××¢×‘×“ ×× ×™×”: {symbol}")
        print(f"{'='*50}")
        
        # ×”×•×¨×“×ª × ×ª×•× ×™×
        df = download_stock_data_yahoo(symbol, start_date, end_date)
        
        if df is not None and not df.empty:
            # ×”××¨×” ×œ×¤×•×¨××˜ ×©×œ× ×•
            formatted_df = convert_to_our_format(df, symbol)
            
            # ×©××™×¨×ª ×”×§×•×‘×¥ ×‘×ª×™×§×™×™×ª raw_price_data
            filename = f"{symbol} Stock Price History.csv"
            success = save_to_csv(formatted_df, filename)
            
            if success:
                print(f"\nğŸ“‹ ×¡×™×›×•× ×¢×‘×•×¨ {symbol}:")
                print(f"âœ… ×”×•×¨×“×• {len(formatted_df)} ×©×•×¨×•×ª × ×ª×•× ×™×")
                print(f"ğŸ’° ××—×™×¨ ××—×¨×•×Ÿ: ${df['Close'].iloc[-1]:.2f}")
                print(f"ğŸ“ˆ ××—×™×¨ ×’×‘×•×” ×‘×™×•×ª×¨: ${df['High'].max():.2f}")
                print(f"ğŸ“‰ ××—×™×¨ × ××•×š ×‘×™×•×ª×¨: ${df['Low'].min():.2f}")
                print(f"ğŸ“Š × ×¤×— ×××•×¦×¢: {df['Volume'].mean():,.0f}")
                
                results[symbol] = {
                    'filename': filename,
                    'filepath': f"data/raw_price_data/{filename}",
                    'rows': len(formatted_df),
                    'last_price': df['Close'].iloc[-1],
                    'high': df['High'].max(),
                    'low': df['Low'].min(),
                    'avg_volume': df['Volume'].mean()
                }
            else:
                print(f"âŒ × ×›×©×œ ×‘×©××™×¨×ª ×”×§×•×‘×¥ ×¢×‘×•×¨ {symbol}")
        else:
            print(f"âŒ ×œ× × ×™×ª×Ÿ ×œ×”×•×¨×™×“ × ×ª×•× ×™× ×¢×‘×•×¨ {symbol}")
    
    return results

# ×”×’×“×¨×ª ×¤×¨××˜×¨×™× - ×‘×“×™×§×” ××”×™×¨×” ×¢× 3 ×× ×™×•×ª ×‘×œ×‘×“
symbols = ["AAPL", "MSFT", "TSLA"]  # ×‘×“×™×§×” ××”×™×¨×” - 3 ×× ×™×•×ª ×‘×œ×‘×“
start_date = "2020-01-01"  # 5 ×©× ×™× ××—×•×¨×”
end_date = "2025-07-28"

print("ğŸš€ ××ª×—×™×œ ×”×•×¨×“×ª × ×ª×•× ×™×...")
print(f"ğŸ“ˆ ×× ×™×•×ª: {', '.join(symbols)}")
print(f"ğŸ“… ×: {start_date}")
print(f"ğŸ“… ×¢×“: {end_date}")
print(f"ğŸ’¾ ×©××™×¨×” ×‘×ª×™×§×™×™×”: data/raw_price_data/")
print("-" * 50)

# ×”×•×¨×“×ª × ×ª×•× ×™× ×œ×›×œ ×”×× ×™×•×ª
results = download_multiple_stocks(symbols, start_date, end_date)

# ×¡×™×›×•× ×›×œ×œ×™
if results:
    print(f"\n{'='*60}")
    print("ğŸ“Š ×¡×™×›×•× ×›×œ×œ×™:")
    print(f"{'='*60}")
    print(f"âœ… ×”×•×¨×“×• × ×ª×•× ×™× ×¢×‘×•×¨ {len(results)} ×× ×™×•×ª")
    
    for symbol, data in results.items():
        print(f"ğŸ“ˆ {symbol}: {data['rows']} ×©×•×¨×•×ª, ××—×™×¨ ××—×¨×•×Ÿ: ${data['last_price']:.2f}")
    
    print(f"\nğŸ’¾ ×§×‘×¦×™× × ×•×¦×¨×• ×‘-data/raw_price_data/:")
    for symbol, data in results.items():
        print(f"   ğŸ“„ {data['filename']}")
else:
    print("âŒ ×œ× ×”×•×¨×“×• × ×ª×•× ×™× ×¢×‘×•×¨ ××£ ×× ×™×”")
